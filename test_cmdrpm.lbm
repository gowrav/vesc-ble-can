;; ==========================
;; Config
;; ==========================
(def SPEED_ERPM 4000)
(def RUN_LENGTH 0.2)
;; ==========================
;; Handle CMD
;; ==========================
(defun handle-cmd (data)
  {;(print "CMD RX:" data)
    (if (eq data 1) {
        (print "Forward")
        (conf-set 'app-to-use 3)
        (set-rpm SPEED_ERPM)
        (sleep RUN_LENGTH)
        (conf-set 'app-to-use 2)
        })
    (if (eq data 2) {(print "Reverse")
        (conf-set 'app-to-use 3)
        (set-rpm (- 0 SPEED_ERPM))
        (sleep RUN_LENGTH)
        (conf-set 'app-to-use 2)
        })
    (if (eq data 0) {(print "Stop")
        (conf-set 'app-to-use 3)
        (set-rpm 0)
        (sleep RUN_LENGTH)
        (conf-set 'app-to-use 2)
        })
  }
)

;; ==========================
;; RX Handler
;; ==========================
(defun proc-data (data) {
  ;(print "RX RAW:" data)
  (if (> (buflen data) 0)
      (handle-cmd (bufget-u8 data 0)))
})

(defun event-handler () {
  (loopwhile t
    (recv
      ((event-data-rx . (? data)) (proc-data data))
      (_ nil))
  )
})

(event-register-handler (spawn event-handler))
(event-enable 'event-data-rx)

(print "Custom CMD listener active")
